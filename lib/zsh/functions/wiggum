wiggum() {
    local prompt_file max_iterations iteration current_branch custom_prompt no_git model

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prompt)
                custom_prompt="$2"
                shift 2
                ;;
            --no-git)
                no_git=1
                shift
                ;;
            -i|--iterations)
                max_iterations="$2"
                shift 2
                ;;
            -m|--model)
                model="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    max_iterations="${max_iterations:-0}"
    prompt_file="${custom_prompt:-PROMPT.md}"

    iteration=0
    current_branch=$(git branch --show-current)

    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "Prompt: $prompt_file"
    echo "Model:  ${model:-opus}"
    echo "Branch: $current_branch"
    [[ $max_iterations -gt 0 ]] && echo "Max:    $max_iterations iterations" || echo "Max:    unlimited"
    [[ -z "$no_git" ]] && echo "Commit: true" || echo "Commit: false"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    if [[ ! -f "$prompt_file" ]]; then
        echo "Error: $prompt_file not found"
        return 1
    fi

    while true; do
        iteration=$((iteration + 1))
        echo -e "\n======================== LOOP $iteration ========================\n"

        if [[ $max_iterations -gt 0 ]] && [[ $iteration -gt $max_iterations ]]; then
            echo "Reached max iterations: $max_iterations"
            break
        fi

        local output=$({
            cat "$prompt_file"
            cat <<EOF

ONLY WORK ON A SINGLE TASK.

## Iteration context

This prompt is iteration number $iteration.

After you have completed the task, output a log entry as JSON on a single line prefixed with WIGGUM_LOG:

\`\`\`
WIGGUM_LOG:{"success":true,"summary":"CSS added to style header","steps_taken":["decided to name CSS file foo.css","created CSS file"],"commands_run":["touch ./foo.css"],"issues_encountered":[]}
\`\`\`

ONLY WORK ON A SINGLE TASK.

If there is no further work to do, output exactly WIGGUM:OVER instead of a log entry.

ONLY WORK ON A SINGLE TASK.
EOF
        } | claude -p \
            --dangerously-skip-permissions \
            --output-format=stream-json \
            --model "${model:-opus}" \
            --verbose)

        if [[ "$output" == *"WIGGUM:OVER"* ]]; then
            echo "Work complete (WIGGUM:OVER)"
            break
        fi

        local log_json=$(echo "$output" | grep -oE 'WIGGUM_LOG:\{[^}]+\}' | head -1 | sed 's/WIGGUM_LOG://' | sed 's/\\"/"/g')
        if [[ -n "$log_json" ]]; then
            local ts=$(date -Iseconds)
            local entry=$(echo "$log_json" | jq --arg ts "$ts" --argjson iter "$iteration" '. + {timestamp: $ts, iteration: $iter}')

            if [[ -f "wiggum_log.json" ]]; then
                jq --argjson entry "$entry" '. += [$entry]' wiggum_log.json > wiggum_log.json.tmp && mv wiggum_log.json.tmp wiggum_log.json
            else
                echo "[$entry]" | jq '.' > wiggum_log.json
            fi

            echo -e "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "$entry" | jq '.'
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        fi

        [[ -z "$no_git" ]] && git commit -am "Wiggum iteration $iteration"
    done
}
